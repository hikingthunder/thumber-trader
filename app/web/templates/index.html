{% extends "base.html" %}

{% block content %}
<header>
    <div>
        <h1>Thumber Trader</h1>
        <div style="font-size: 0.9rem; color: #94a3b8;">
            Product: <span style="color: white;">{{ product_id }}</span> |
            Mode: <span style="color: {{ 'orange' if paper_trading else 'white' }};">
                {{ 'PAPER TRADING' if paper_trading else 'LIVE' }}
            </span>
        </div>
    </div>

    <nav>
        <a href="/">Dashboard</a>
        <a href="/export">Export</a>
        <a href="/config">Configuration</a>
    </nav>
    <div id="controls">
        <button class="btn btn-success" hx-post="/dashboard/control/start" hx-target="#stats-widget">Start</button>
        <button class="btn btn-danger" hx-post="/dashboard/control/stop" hx-target="#stats-widget">Stop</button>
    </div>
</header>

<main class="dashboard-grid">
    <!-- Price Chart Widget -->
    <div class="card" style="grid-column: span 2;">
        <h2>Market Chart ({{ product_id }})</h2>
        <div id="chart-container" style="height: 400px; width: 100%;"></div>
    </div>

    <!-- Stats Widget -->
    <div id="stats-widget" class="card" hx-get="/dashboard/stats" hx-target="this" hx-trigger="load, every 2s">
        <!-- Initial Content Loading... -->
        <p>Loading stats...</p>
    </div>

    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        const chart = LightweightCharts.createChart(document.getElementById('chart-container'), {
            layout: {
                backgroundColor: '#1e293b',
                textColor: '#f1f5f9',
            },
            grid: {
                vertLines: { color: '#334155' },
                horzLines: { color: '#334155' },
            },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            priceScale: { borderColor: '#334155' },
            timeScale: { borderColor: '#334155' },
        });

        const lineSeries = chart.addLineSeries({
            color: '#3b82f6',
            lineWidth: 2,
        });

        // Simple poll for price updates
        setInterval(async () => {
            try {
                const response = await fetch('/dashboard/price');
                const data = await response.json();
                if (data.price > 0) {
                    lineSeries.update({
                        time: data.time,
                        value: data.price
                    });
                }
            } catch (e) {
                console.error("Chart update failed:", e);
            }
        }, 2000);
    </script>

    <!-- Active Orders Widget -->
    <div class="card" style="grid-column: span 2;">
        <h2>Active Orders</h2>
        <div id="orders-widget" hx-get="/dashboard/orders" hx-trigger="load, every 2s">
            <p>Loading orders...</p>
        </div>
    </div>

    <!-- Recent Fills Widget -->
    <div class="card" style="grid-column: span 2;">
        <h2>Recent Fills</h2>
        <div id="fills-widget" hx-get="/dashboard/fills" hx-trigger="load, every 5s">
            <p>Loading fills...</p>
        </div>
    </div>
</main>
{% endblock %}